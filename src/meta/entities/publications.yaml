publications:
  type: table
  displayName: Publications
  order: '10'
  primaryKey: ID
  scheme:
    columns:
    - ID:
        type: KEYTYPE
        autoIncrement: true
        primaryKey: true
    - ref:
        type: VARCHAR(100)
        canBeNull: true
    - PMID:
        type: BIGINT UNSIGNED
        canBeNull: true
    - authors:
        type: TEXT
        canBeNull: true
    - affiliation:
        type: TEXT
        canBeNull: true
    - title:
        type: TEXT
        canBeNull: true
    - source:
        type: VARCHAR(200)
        canBeNull: true
    - journalTitle:
        type: VARCHAR(100)
        canBeNull: true
    - year:
        type: INT UNSIGNED
        canBeNull: true
    - month:
        type: VARCHAR(10)
        canBeNull: true
    - volume:
        type: INT UNSIGNED
        canBeNull: true
    - issue:
        type: VARCHAR(24)
        canBeNull: true
    - pageFrom:
        type: VARCHAR(24)
        canBeNull: true
    - pageTo:
        type: VARCHAR(24)
        canBeNull: true
    - language:
        type: VARCHAR(3)
        canBeNull: true
    - publicationType:
        type: VARCHAR(50)
        canBeNull: true
    - abstract:
        type: TEXT
        canBeNull: true
    - PMCID:
        type: BIGINT UNSIGNED
        canBeNull: true
    - url:
        type: VARCHAR(100)
        canBeNull: true
  queries:
  - '*** Selection view ***':
      type: 1D
      roles: Administrator
      code: |-
        SELECT id AS "Code", CONCAT(ref, ' - ', PMID) AS "Name" FROM publications
  - Compact view:
      defaultView: true
      type: 1D
      roles: Annotator
      operations:
      - Delete
      - InsertPublication
      - FillFromMedline
      - EditProjectInfo
      - Filter
      code: |-
          SELECT
            p.ID AS "___ID",
            p.ref AS "Reference",
            IFNULL(p.year, null) AS "Year",
            IFNULL(p.language , '') AS "Lang.",
            p2pr.importance AS "Imp.",
            CONCAT(
              IFNULL( CONCAT(p.authors, '<br>'), ' '),
              IFNULL( CONCAT('<b>', p.title, '</b><br>'),  ' '),
              IFNULL( CONCAT('<i>', p.source, '</i></br>'), ''),
              IFNULL( CONCAT('PMID: ', '<a href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&db=PubMed&list_uids=',
                              TO_CHAR(p.pmid), '&dopt=Abstract" target="blanck">', TO_CHAR(p.pmid), '</a>'), ' '),
              IFNULL( CONCAT('<br>URL: <a href=', p.url, '>', p.url, '</a>'), ' ')
            ) AS "Description",
            IFNULL(p2pr.comment, ' ') AS "Comment",
            CONCAT(
              IFNULL( '<sql default="Нажмите">
                SELECT CONCAT('<a href="api/download?_t_=attachments&ID=', a.id, '">', a.name, '</a>(',  IFNULL(LENGTH(a.data), '0'), ')' )
                FROM attachments a
                WHERE a.publicationID = <var:___ID/>
                </sql>' , ''
              ),
              CONCAT('<div class="text-center"><a href="#!table/attachments/Attachments/publicationID=', p.id, '">Edit</a></div>')
            ) AS "Text"
          FROM publications p
          <if parameter="_cat_">
            INNER JOIN classifications pcls ON pcls.recordID = CONCAT('projectCategory.', '<parameter:_cat_ />')
            INNER JOIN categories cat ON cat.id = pcls.categoryID
              AND cat.name IN (<session:biostore_projects multiple="true"/>)
            INNER JOIN publication2project p2pr
               ON p2pr.publicationID = p.ID
              AND p2pr.projectID = cat.name
          </if>
          <unless parameter="_cat_">
            LEFT JOIN publication2project p2pr ON p2pr.publicationID = p.ID AND 1=2
          </unless>
          ORDER BY p.ref
  - Detailed view:
      type: 1D
      roles: Annotator
      operations:
      - Delete
      - InsertPublication
      - FillFromMedline
      - EditProjectInfo
      - Filter
      code: |-
          SELECT
            p.ID AS "___ID",
            CONCAT(IFNULL(CONCAT('<b>', p.ref, '</b><br>'), ''),
                    IFNULL( CONCAT('Importance: ', p2pr.importance, '; '), ''),
                    IFNULL( CONCAT(p.publicationType), ''),
                    IFNULL( CONCAT('; ',  p.language), ''), '.<br><br>',
                    IFNULL( CONCAT(p.authors, '<br>'), ''),
                    IFNULL( CONCAT('<b>', p.title, '</b><br>'),   ''),
                    IFNULL( CONCAT('<i>', p.source, '</i><br>'), ''),

                    IFNULL( CONCAT('<br>Key words: ', p2pr.keyWords, '<br>'), ''),
                    IFNULL( CONCAT('<br>', p.abstract, '<br><br>'), '<br><br>'),
                    IFNULL( CONCAT('PMID: ', '<a href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&db=PubMed&list_uids=',
                            TO_CHAR(p.PMID), '&dopt=Abstract" target="blanck">', TO_CHAR(p.PMID), '</a><br>'), ''),
                    IFNULL( CONCAT('URL: <a href=', p.url, '>', p.url, '</a><br>'), ''),
                    IFNULL(p2pr.comment, ''),
                    IFNULL(CONCAT(
                       IFNULL( '<sql default="Нажмите">
                         SELECT CONCAT('<a href="api/download?_t_=attachments&ID=', a.id, '">', a.name, '</a>(',  IFNULL(LENGTH(a.data), '0'), ')' )
                         FROM attachments a
                         WHERE a.publicationID = <var:___ID/>
                         </sql>' , ''
                       )

                    ), ''),
                    IFNULL(CONCAT('<a class="d-block" href="#!table/attachments/Attachments/publicationID=', p.id, '">Edit</a>'))
            ) AS "Publication"
          FROM publications p
          <if parameter="_cat_">
            INNER JOIN classifications pcls ON pcls.recordID = CONCAT('projectCategory.', '<parameter:_cat_ />')
            INNER JOIN categories cat ON cat.id = pcls.categoryID
              AND cat.name IN (<session:biostore_projects multiple="true"/>)
            INNER JOIN publication2project p2pr
               ON p2pr.publicationID = p.ID
              AND p2pr.projectID = cat.name
          </if>
          <unless parameter="_cat_">
            LEFT JOIN publication2project p2pr ON p2pr.publicationID = p.ID AND 1=2
          </unless>
          ORDER BY p.ref
  operations:
  - InsertPublication:
      type: Groovy
      roles: Annotator
      file: publications/InsertPublication.groovy
  - FillFromMedline:
      records: 2
      type: Groovy
      roles: Administrator
      file: publications/FillFromMedline.groovy
  - Delete:
      records: 2
      roles: Annotator
      code: com.developmentontheedge.be5.operations.SilentDeleteOperation
  - EditProjectInfo:
      records: 1
      type: Groovy
      roles: Annotator
      file: publications/EditProjectInfo.groovy
  - Filter:
      roles: Administrator
      layout: '{"type":"modalForm"}'
      code: com.developmentontheedge.be5.operations.FilterOperation