publications:
  type: table
  displayName: Publications
  order: '10'
  primaryKey: ID
  scheme:
    columns:
    - ID:
        type: KEYTYPE
        autoIncrement: true
        primaryKey: true
    - ref:
        type: VARCHAR(100)
        canBeNull: true
    - PMID:
        type: BIGINT UNSIGNED
        canBeNull: true
    - authors:
        type: TEXT
        canBeNull: true
    - affiliation:
        type: TEXT
        canBeNull: true
    - title:
        type: TEXT
        canBeNull: true
    - source:
        type: VARCHAR(200)
        canBeNull: true
    - journalTitle:
        type: VARCHAR(100)
        canBeNull: true
    - year:
        type: INT UNSIGNED
        canBeNull: true
    - month:
        type: VARCHAR(10)
        canBeNull: true
    - volume:
        type: INT UNSIGNED
        canBeNull: true
    - issue:
        type: VARCHAR(24)
        canBeNull: true
    - pageFrom:
        type: VARCHAR(24)
        canBeNull: true
    - pageTo:
        type: VARCHAR(24)
        canBeNull: true
    - language:
        type: VARCHAR(3)
        canBeNull: true
    - publicationType:
        type: VARCHAR(50)
        canBeNull: true
    - abstract:
        type: TEXT
        canBeNull: true
    - PMCID:
        type: BIGINT UNSIGNED
        canBeNull: true
    - url:
        type: VARCHAR(100)
        canBeNull: true
  queries:
  - '*** Selection view ***':
      type: 1D
      roles: Administrator
      code: |-
        SELECT id AS "Code", CONCAT(ref, ' - ', PMID) AS "Name" FROM publications
  - Compact view:
      defaultView: true
      type: 1D
      roles: Annotator
      operations:
      - Delete
      - Edit
      - Insert
      - InsertPublicationByPMID
      - FillFromMedline
      - Filter
      code: |2-
          SELECT
            p.ID AS "___ID",
            p.ref AS "Reference",
            IFNULL(p.year, null) AS "Year",
            IFNULL(p.language , '') AS "Lang.",
            p2pr.importance AS "Imp.",
            CONCAT(
              IFNULL( CONCAT(p.authors, '<br>'), ' '),
              IFNULL( CONCAT('<b>', p.title, '</b><br>'),  ' '),
              IFNULL( CONCAT('<i>', p.source, '</i></br>'), ''),
              IFNULL( CONCAT('PMID: ', '<a href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&db=PubMed&list_uids=',
                              TO_CHAR(p.pmid), '&dopt=Abstract" target="blanck">', TO_CHAR(p.pmid), '</a>'), ' '),
              IFNULL( CONCAT('<br>URL: <a href=', p.url, '>', p.url, '</a>'), ' ')
            ) AS "Description",
            IFNULL(p2pr.comment, ' ') AS "Comment",
            CONCAT(
              IFNULL( '<sql default="Нажмите">
                SELECT CONCAT('<a href="api/download?_t_=attachments&ID=', a.id, '">', a.name, '</a>(',  IFNULL(LENGTH(a.data), '0'), ')' )
                FROM attachments a
                WHERE a.publicationID = <var:___ID/>
                </sql>' , ''
              ),
              CONCAT('<div class="text-center"><a href="#!table/attachments/Attachments/publicationID=', p.id, '">Edit</a></div>')
            ) AS "Text",
            cat.name
          FROM publications p
          LEFT JOIN publication2project p2pr ON p2pr.publicationID = p.ID
          INNER JOIN classifications cls ON cls.recordID = CONCAT('publications.', p.ID)
          INNER JOIN categories cat ON cls.categoryID = cat.ID AND cat.name IN (<session:biostore_projects_sql/>)
          ORDER BY p.ref
  - Detailed view:
      type: 1D
      roles: Annotator
      operations:
      - Delete
      - Edit
      - Insert
      - InsertPublicationByPMID
      - FillFromMedline
      - Filter
      code: |2-
          SELECT
            p.ID AS "___ID",
            CONCAT(IFNULL(CONCAT('<b>', p.ref, '</b><br>'), ''),
                    IFNULL( CONCAT('Importance: ', p2pr.importance, '; '), ''),
                    IFNULL( CONCAT(p.publicationType), ''),
                    IFNULL( CONCAT('; ',  p.language), ''), '.<br><br>',
                    IFNULL( CONCAT(p.authors, '<br>'), ''),
                    IFNULL( CONCAT('<b>', p.title, '</b><br>'),   ''),
                    IFNULL( CONCAT('<i>', p.source, '</i><br>'), ''),

                    IFNULL( CONCAT('<br>Key words: ', p2pr.keyWords, '<br>'), ''),
                    IFNULL( CONCAT('<br>', p.abstract, '<br><br>'), '<br><br>'),
                    IFNULL( CONCAT('PMID: ', '<a href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&db=PubMed&list_uids=',
                            TO_CHAR(p.PMID), '&dopt=Abstract" target="blanck">', TO_CHAR(p.PMID), '</a><br>'), ''),
                    IFNULL( CONCAT('URL: <a href=', p.url, '>', p.url, '</a><br>'), ''),
                    IFNULL(p2pr.comment, ''),
                    IFNULL(CONCAT(
                       IFNULL( '<sql default="Нажмите">
                         SELECT CONCAT('<a href="api/download?_t_=attachments&ID=', a.id, '">', a.name, '</a>(',  IFNULL(LENGTH(a.data), '0'), ')' )
                         FROM attachments a
                         WHERE a.publicationID = <var:___ID/>
                         </sql>' , ''
                       )

                    ), ''),
                    IFNULL(CONCAT('<a class="d-block" href="#!table/attachments/Attachments/publicationID=', p.id, '">Edit</a>'))
            ) AS "Publication"
          FROM publications p
          LEFT JOIN publication2project p2pr
                 ON p2pr.publicationID = p.ID
          ORDER BY p.ref
  operations:
  - InsertPublicationByPMID:
      type: Groovy
      roles: Annotator
      file: publications/InsertPublicationByPMID.groovy
  - FillFromMedline:
      records: 2
      type: Groovy
      roles: Administrator
      file: publications/FillFromMedline.groovy
  - Delete:
      records: 2
      roles: Annotator
      code: com.developmentontheedge.be5.operations.SilentDeleteOperation
  - Edit:
      records: 1
      roles: Administrator
      code: com.developmentontheedge.be5.operations.SilentEditOperation
  - Insert:
      roles: Administrator
      code: com.developmentontheedge.be5.operations.SilentInsertOperation
  - Filter:
      roles: Administrator
      layout: '{"type":"modalForm"}'
      code: com.developmentontheedge.be5.operations.FilterOperation